format_version: 10

environments:
  production:
    pipelines:
      - nbb_production_deployment_pipeline

pipelines:

  nbb_production_deployment_pipeline:

    group: NodeBulletinBoardApplication
    lock_behavior: unlockWhenFinished
    display_order: 5
    
    materials:
      
      upstream:
        pipeline: nbb_qa_deployment_pipeline
        stage: nbb_qa_deployment_stage
        name: upstream_pipeline
      
      gitRepository:
        git: "https://github.com/sqaisar/k8-deployment-manifests.git"
        branch: master
    
    stages:
      - nbb_production_deployment_stage:

          fetch_materials: true
          keep_artifacts: false
          clean_workspace: false

          approval:
            type: manual

          jobs:

            deployment:

              timeout: 0
              elastic_profile_id: agent-profile

              tasks:
                  
              - fetch:

                  artifact_id: bulletin-board
                  pipeline: nbb_build_publish_pipeline/nbb_test_application_pipeline/nbb_claybox_deployment_pipeline/nbb_qa_deployment_pipeline
                  stage: nbb_build_publish_stage
                  job: build_image
                  artifact_origin: external
                  run_if: passed

                  options:
                    EnvironmentVariablePrefix: ''
                    SkipImagePulling: 'true'

              - script: |
                  echo "Generating manifests! Although they are already generated :)"
                  pwd
                  ls -a ./

