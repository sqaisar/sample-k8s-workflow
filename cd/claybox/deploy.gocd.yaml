format_version: 10

environments:
  claybox:
    environment_variables:
      test_var: "abc"
      # KUBECONFIG: "{{SECRET:[secret-for-dockerhub-credentials][KUBECONFIG]}}"
    pipelines:
      - nbb_claybox_deployment_pipeline

pipelines:

  nbb_claybox_deployment_pipeline:

    group: NodeBulletinBoardApplication
    lock_behavior: unlockWhenFinished
    display_order: 3

    materials:
      
      upstream:
        pipeline: nbb_test_application_pipeline
        stage: nbb_test_application_stage
        name: upstream_pipeline
      
      gitRepository:
        git: "https://github.com/sqaisar/k8-deployment-manifests.git"
        branch: master
    
    stages:
      - nbb_claybox_deployment_stage:

          fetch_materials: true
          keep_artifacts: false
          clean_workspace: false

          approval:
            type: success

          jobs:

            deployment:

              timeout: 0
              elastic_profile_id: agent-profile

              tasks:
                
              - fetch:
          
                  artifact_id: bulletin-board
                  pipeline: nbb_build_publish_pipeline/nbb_test_application_pipeline
                  stage: nbb_build_publish_stage
                  job: build_image
                  artifact_origin: external
                  run_if: passed

                  options:
                    EnvironmentVariablePrefix: ''
                    SkipImagePulling: 'true'
                    
              - script: |
                  echo "Generating manifests! Although they are already generated :)"
                  image=$( echo "$ARTIFACT_IMAGE" | cut -d ":" -f 1)
                  tag=$( echo "$ARTIFACT_IMAGE" | cut -d ":" -f 2)
                  echo "Image is: $image"
                  echo "Tag is: $tag"
                  helm install -n claybox node-bulletin-board-claybox node-bulletin-board --set image.repository=$image --set image.tag=$tag --set ingress.hosts[0].host node-bulletin-board-claybox.local

                  

