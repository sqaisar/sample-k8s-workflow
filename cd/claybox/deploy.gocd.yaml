format_version: 10

environments:
  claybox:
    environment_variables:
      KUBECONFIG: "YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSQ2FrTkRRV1UyWjBGM1NVSkJaMGxDUVZSQlRrSm5hM0ZvYTJsSE9YY3dRa0ZSYzBaQlJFRldUVkpOZDBWUldVUldVVkZFUlhkd2RHRlhOWEFLWVROV2FWcFZUa0pOUWpSWVJGUkplVTFFYTNoTlJFbDRUVVJyZDA1c2IxaEVWRTE1VFVScmQwOUVTWGhOUkd0M1RteHZkMFpVUlZSTlFrVkhRVEZWUlFwQmVFMUxZbGRzZFdGWGRERlpiVlpFVVZSRFEwRlRTWGRFVVZsS1MyOWFTV2gyWTA1QlVVVkNRbEZCUkdkblJWQkJSRU5EUVZGdlEyZG5SVUpCUzI1bUNtVlpOVGxHTjJkalNtdzVPVTV6ZWxFeWFHaE1hRWM0VDBGTVZHWjRlaXM1Ums1S2RtOHdaa1JDYTBOTVZFMVZSMEZ0UzBWS2RGWm5Va0ZLU0ZCMmRtY0tWWFE1TUVaRlYyMUxha2xMWVdwelJtbDBNek5xVW5sb2FIcGxiV2RXWWpKSFVYRlNVMk50VlRGRmJXbzJPVFE1ZUdWWFdYSmpUMHQzYkVwMVoyaEJaUXBzU1RKWlYyNXFNMWhSTW1zMVpWbzBRVkZIWm5ocU16Z3lORVJySzNaSVVVcDRNR2N4U21GbFFqSldTM2xXZW5kTFJHZEJkVGsxWkZkU1NpODFNMHMzQ2xvNU1VaFBZazB3UW5kemRHcG9TelUzWTNkQ2ExQlNOM3AzZUhaaGRHVkhkMVJRWlhWWVVFWldZWHBaVkdoUlUycE5lbHB4V1hOMmRGcDJWVkpDYmtRS09ESlNRbU5JV0hnelFuaFRialZIUlROeFFUWnZkamh2VmpKdlRtbHRaVFZvSzBSNVpYSmlXbTloVEhSSFRUZHFTaTlLVUhVMFZWaEpOblZIZDJ3NVN3cHZTekZxY3l0bVNsRkhSSHBHU0RsTU15OHdRMEYzUlVGQllVNW9UVVk0ZDBSbldVUldVakJRUVZGSUwwSkJVVVJCWjB0clRVSXdSMEV4VldSS1VWRlhDazFDVVVkRFEzTkhRVkZWUmtKM1RVTkNaMmR5UW1kRlJrSlJZMFJCVkVGUVFtZE9Wa2hTVFVKQlpqaEZRbFJCUkVGUlNDOU5RakJIUVRGVlpFUm5VVmNLUWtKUk5uWkRlVFJvU1c0MmEySm1SSGxCZFVGblpDdGlaR1prUmtsNlFVNUNaMnR4YUd0cFJ6bDNNRUpCVVhOR1FVRlBRMEZSUlVGR1YwZ3ZOM1JLYndwSVQyY3dUeTl2ZW1vemJUYzVWRU5oYnpSS2VGVkhRbFJXUzA1TFZ6RlZlWFV4VW1ocFFsVndTWGhLUXpCblZVVnZVR05VV25WSGFGRlVTVEJPTDJ0UUNqTjFPSEZpVlhNNEt6TnFVMGgzWVdWMU1IZExkalJqWm5kQ05DdHdUMkptZVVNM1ltOUdUbTFuZDI5U2RuUTFaV1pEWkVOeVVYQjNhbnBMWVRCWWR6QUtSbVl2VTFSV2IxSlRjRlJPVVZwdVVtUnZMMGczY25WVmVVdGlTbXAyTmpGdVFVRldPVXROY1ZCVU5sQk1haTlQVTJWaFkzTmxTMnBtTUhkSE5YWjJiZ3A0VmxZeFVHbHdTalpvVGpOV1NWSjJaM1pFT1c5UGVsTnpibTVQTm05V1pWWnhOM0E0Ulc1RGVFUnFRVk5xYTBaNlRVNW1lRzByUzBkb2RWbENSamRpQ2l0c2VsZEhSMkZXTWxKcVYyaGFVRlpSY0ZWWE5uWndZazF1WnpaWlptWmxiamh1ZVdKMVVuZHJiR1Z3YlZWS2MzSnJVMjB2YVRrd1YxbExWVzh3UTFFS1JucG1MekEwYVhwRlVsSm9WbWM5UFFvdExTMHRMVVZPUkNCRFJWSlVTVVpKUTBGVVJTMHRMUzB0CiAgICBzZXJ2ZXI6IGh0dHBzOi8vMTkyLjE2OC40OS4yOjg0NDMKICBuYW1lOiBtaW5pa3ViZQpjb250ZXh0czoKLSBjb250ZXh0OgogICAgY2x1c3RlcjogbWluaWt1YmUKICAgIG5hbWVzcGFjZTogZ29jZAogICAgdXNlcjogbWluaWt1YmUKICBuYW1lOiBtaW5pa3ViZQpjdXJyZW50LWNvbnRleHQ6IG1pbmlrdWJlCmtpbmQ6IENvbmZpZwpwcmVmZXJlbmNlczoge30KdXNlcnM6Ci0gbmFtZTogbWluaWt1YmUKICB1c2VyOgogICAgY2xpZW50LWNlcnRpZmljYXRlLWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVVJKVkVORFFXZHRaMEYzU1VKQlowbENRV3BCVGtKbmEzRm9hMmxIT1hjd1FrRlJjMFpCUkVGV1RWSk5kMFZSV1VSV1VWRkVSWGR3ZEdGWE5YQUtZVE5XYVZwVlRrSk5RalJZUkZSSmVVMUVhM2hQUkVFeVRWUnJNVTFXYjFoRVZFa3hUVVJyZUU5RVFUSk5WR3N4VFZadmQwMVVSVmhOUWxWSFFURlZSUXBEYUUxUFl6TnNlbVJIVm5SUGJURm9Zek5TYkdOdVRYaEdha0ZWUW1kT1ZrSkJUVlJFVnpGd1ltMXNjbVJYU214TVdGWjZXbGhKZDJkblJXbE5RVEJIQ2tOVGNVZFRTV0l6UkZGRlFrRlJWVUZCTkVsQ1JIZEJkMmRuUlV0QmIwbENRVkZETjI1eFFYYzJaVVZuVFhOdk5GUTRSMFp4UkZvMGFIRjZZM0YxWkc0S1pFMTVWaTlHTUVoeGNuQjRTRlJXTjNjeVkwZHFTelZSY2pVeU9ISldORzgzUldGMGVFbHZaMk51SzFSa2NFcFpRbU5EZGtwVVRVYzVOalJ6YVRKUGJRcFBTbFYwUVdKVmNVcGxSMWt5VXpST1FsQkRaWE5IVFd0SVFXWkdOM2RQVEdrM2RHVjFaMHgyYzNNd1NWRmtOazAwVG1OWlQzQkdXa1JQYUU1V2VUbFFDa2gxTlhkMU1rdHVRMVZsWTBWblMwSkhjVmhIUjJwSFYxaHpNa2xEUVZZd1VrVmtSbTVCVURKemNWUkNNalkzYjJkbU4ySm9VRmREYURGa2FrVkxVallLYUhOQ1VqQTRNVTVITXk4MmVHd3hOVU5FUzJWbU4yNURVMWxzTDFBd1dIbFJhbVpUTkRaVU1FNDJZelExTVVsTGRsVklXRFowZDNZMU1ERnVka3hXU1FvcmF6QmFXbWxTUTFjNE5rZFFlbXRtZW5CNEwwSklhVFU1YWs5ak1GVk1helJRVGl0TFIxRXdiRUZvZDBaRVQzYzBUR3BIV2xOMllrRm5UVUpCUVVkcUNsbEVRbVZOUVRSSFFURlZaRVIzUlVJdmQxRkZRWGRKUm05RVFXUkNaMDVXU0ZOVlJVWnFRVlZDWjJkeVFtZEZSa0pSWTBSQlVWbEpTM2RaUWtKUlZVZ0tRWGRKZDBSQldVUldVakJVUVZGSUwwSkJTWGRCUkVGbVFtZE9Wa2hUVFVWSFJFRlhaMEpSTm5aRGVUUm9TVzQyYTJKbVJIbEJkVUZuWkN0aVpHWmtSZ3BKZWtGT1FtZHJjV2hyYVVjNWR6QkNRVkZ6UmtGQlQwTkJVVVZCYTBOTlVIUm9PRWhTWmtsSlVraGFlRk52YkZoVVpWQXZVMlkzYUdGWWNYTnNTMWh0Q2tGSU9UZG5WbGRZVEdSclVUa3ZkbEZTU25oR0wyNDFRVU5ETkdWdEwwOUhZVEUwYzFGamNWbERZWEJhUjNCSU1qTkZSRFZvUlhCU01sZEZTRU01V25FS2RqTkpWMVJvYjJGNFYwcGFUblZWT1daSU1FUm5SMGRoYjFOWWRFd3ljM2cyVWtSME1IUkZVbmN5VldGa1pESTFaVUphU1dNNU56a3JWamd3YzA1VVdRbzRXSFl4U2tKb01qZ3ZWMWRaZGxnM2NqVkRValpPZDNGSVpXdG1OMjkyWjA5ak1tRm9OMkZXYjJ0YVRsVlhXSFJGTWtKUFN6aGxUa3BYUkVSSE1YWnlDbkZrUldGTVRXUkVhbGhVWTFOSkwzVndXRVpNVmpOUGJVMU9hRVV3TTJaU1dteExRemxOYzNoeFNrdG5ZMDV5UjFaek5qRnZObHBtUVZaNGVGSndNVWNLVUZwemIwZFpjVzFJVjJKRmVWaFNNa3hHVTFwSmJFRjJOMFpNZWpFdlJscEthalJVVTFKQ1dtUTFReTk0UlRST1RHYzlQUW90TFMwdExVVk9SQ0JEUlZKVVNVWkpRMEZVUlMwdExTMHQKICAgIGNsaWVudC1rZXktZGF0YTogTFMwdExTMUNSVWRKVGlCU1UwRWdVRkpKVmtGVVJTQkxSVmt0TFMwdExRcE5TVWxGY0VGSlFrRkJTME5CVVVWQmRUVTJaMDFQYm1oSlJFeExUMFV2UW1oaFp6SmxTV0Z6TTB0eWJsb3pWRTFzWm5oa1FqWnhObU5TTURGbE9FNXVDa0p2ZVhWVlN5dGtka3N4WlV0UGVFZHlZMU5MU1VoS0wyc3pZVk5YUVZoQmNubFZla0oyWlhWTVNYUnFjR3BwVmt4UlJ6RkxhVmhvYlU1cmRVUlJWSGNLYm5KQ2FrcENkMGg0WlRoRWFUUjFOMWh5YjBNM04weE9RMFZJWldwUFJGaEhSSEZTVjFGNmIxUldZM1pVZURkMVkweDBhWEIzYkVodVFrbERaMUp4YkFwNGFHOTRiR3czVG1sQlowWmtSVkpJVWxwM1JEbHlTMnQzWkhWMU5rbElLekkwVkRGbmIyUllXWGhEYTJWdllrRlZaRkJPVkZKMEx5dHpXbVJsVVdkNUNtNXVLelYzYTIxS1pubzVSamhyU1RNd2RVOXJPVVJsYms5UFpGTkRjakZDTVN0eVkwd3JaRTVhTjNreFUxQndUa2RYV1d0UmJIWlBhR280TlVnNE5tTUtabmRTTkhWbVdYcHVUa1pETlU5RWVtWnBhR3RPU2xGSlkwSlJlbk5QUXpSNGJWVnlNbmRKUkVGUlFVSkJiMGxDUVZGRE1GSkthRlZDZUZCdmRGRlJOUXByVDBFelVrMVdOV3B4VkdWeVZrMUVkekpUYWtrNFVtSkVialYyUjI5d09UZFBVemRzVlZsVVptNXNTR2hUWnpSc04xUmtWbm80UlV0Q09VOUdOWEJMQ2l0MFVVWk9UeTlRV0ZGRk9FTllNMjluZFhSTFVVSTNTMkpZVmxOUlJFbFJSR3hSU0d4VFJHTXpRbGhZTlRKMk0yc3pNbTVoV1VKVGQxQkNhRmszUTNFS2JWbHVlRE5MZHpBM1RVeDZUa3hpWmtKaVFrTkljbTFQUm5OME5FNTFlRzk2VGxWVk4xRlNkamczUzAxMmREbHdXVTQ0Ym0xMlJtZFBUbGhLTmtFd1J3cFZka3B4TUZkd2JEQkNla1UyTVM5RE0zZHFjRWhOT0hwWGJIUlFLMFZOUkZJMVVWQjVlWEVyU2tOaGQzcEZUellyZHpaVVZqUlBTVkpaUTFKSE9DOHhDa1JsYzJKMFprSlBaa1ZpUlZoVGVrTnRWVkpSYjFkbk5XSTFWWE54U0RkWVJVUnpOekJSTmpSU1lsUkJPRGhYVms1eU5WTlFTV3QzT1hWS1NFMHZTMGtLVjFaMmFWaHZUVFZCYjBkQ1FVOUViVFZ6Y0RVNGN6WTFPRXBIWjFwU1JYWnVRVXQyVlVzclZYUmliV05ZUWpKaGNVMUJWRE5ZVWpOeE5tUjNRM0k0ZUFwak56VXpObTFGV1RWbWN6VTJSSE5FYmpOUWNqWndUMGxKVlN0WWVWaFJZMVV6Wm5GUVRWUTJUMW9yTm5GNFlYcG5RVWhyZGxJd09VNXJNV013TjBoekNqTkxVVWx6UlU0ek1WTjFTMjFtYlc1VlMwRllUalJ6UldSd01XSnlZbVJxVW1reGRtRXlha0l5ZFRsTFZqbHBaVEV4VGpWbGRqUm1RVzlIUWtGT1YxRUtRVVpMY2xsVFYzZEVhVWhCT1RodVJsSktkVGR4VDJwQ2JscHNWbGt2VjBsbldFdHhTaXRGVjNWQ2VXb3plRXBPVDAwd1MwNVFiRFZ1ZG5GVEswWlJhQW81TTBwR016a3piM05IZWtsek1qUlphMEpaYURKRlpDOVFhVk5MTm1aNVV5OVpVemRRZEZwUWFVWTFaRVJ6YzFJMU0zcDVZa2hYTDFWWVNVSlRVMHBSQ21zMmRVczJZbXBzYlc5a2FWZ3dURVJOVWpCSU0ycDRORTU0YUZKV1JVWTVUMnhxYzBWTFRFWkJiMGRCU1c0d1IwMHhTMVZITkU5RlJYSkViMFJ6VTJjS1VtZEZaMlpIZUhadFlrVlRjSGtyUzFwVWIyMXZZU3RuVlZOTWNsbDJjSGRhTW5JMFRrUXJaazVRUm1sWVdIQnRkakUwVlUxT0sxWlVRMFpaYzFWbFR3cDJWSEpqWVhSQ09HVmlVV3RtUjNreVYzQlFOMDVFY1c4d2VVSkVSRzEyYlZGbWJHSkliREpKUVZFNVYwbFhVelZDYmxCSkwzSmhSMmRuWTBoRmNrcFZDbXh4T0ZwYU5EQnBlRGhOT0hsWGJFTldMMmwyUm1Jd1EyZFpRVlExUVRKcWNGbExkVEVyTnpWQ1pHZFBWM1ZzUVN0QlIweGlSREJhWjNaTFJXTXJjR0VLYlRZMlRFMUhjVVpuUmpOUFpuQk1SSGhwWlZrNVRreDRNRFkxT1ZvMGVEaG5SRmRTYmxwTFVrUXdRbTVEVEV0cE0xSlJaakZMU1dSR1ZFMXNObmx5YUFweFpUYzBWbmRCUldsbVdrOTNObEZxTlhoQ2FrSjVZVEo2TldaWlRXeHJUM0ZUYlV4d2VHSXhaRkozWVZFNFVGaFRSbmhUYkZndlRVeEJZMFU0Ym5vd0NuVXdabmhaVVV0Q1oxRkVTMkZrYlhGTGFDdHRlRTkxVEM5a01WVnFXVXh1T1ZwcWQzcFNNWFo1WjNGRVUyZDJiVXhYVmxKRmFXMXBiWHAxYVRjeGFHa0tMM2NyVVRGQ09GQlJSRTlFUkhKcU5IcE1RamRpTkM5dllqQmtjRGwwWlU5cFpGWXhWRXRoWW5GUE1YUnJOV0pKTVZWWmJtTkpWblIwTmtjM2RIcFBVUXBJYlZWR1pFWjFRVTFXVDNaeWJtNXVjV1ZOTTNVNGQwSkdkMWhTVWpKYU56SnpiR2hJZWpCd2MzQmlSV0kwVm1OVVFVbG9XbmM5UFFvdExTMHRMVVZPUkNCU1UwRWdVRkpKVmtGVVJTQkxSVmt0TFMwdExRPT0="
      # KUBECONFIG: "{{SECRET:[secret-for-dockerhub-credentials][KUBECONFIG]}}"
    pipelines:
      - nbb_claybox_deployment_pipeline

pipelines:

  nbb_claybox_deployment_pipeline:

    group: NodeBulletinBoardApplication
    lock_behavior: unlockWhenFinished
    display_order: 3

    materials:
      
      upstream:
        pipeline: nbb_test_application_pipeline
        stage: nbb_test_application_stage
        name: upstream_pipeline
      
      gitRepository:
        git: "https://github.com/sqaisar/k8-deployment-manifests.git"
        branch: master
    
    stages:
      - nbb_claybox_deployment_stage:

          fetch_materials: true
          keep_artifacts: false
          clean_workspace: false

          approval:
            type: success

          jobs:

            deployment:

              timeout: 0
              elastic_profile_id: agent-profile

              tasks:
                
              - fetch:

                  artifact_id: bulletin-board
                  pipeline: nbb_build_publish_pipeline/nbb_test_application_pipeline
                  stage: nbb_build_publish_stage
                  job: build_image
                  artifact_origin: external
                  run_if: passed

                  options:
                    EnvironmentVariablePrefix: ''
                    SkipImagePulling: 'true'
                    
              - script: |
                  echo "Generating manifests! Although they are already generated :)"
                  echo $KUBECONFIG | base64 -d > ~/.kube/config

                  kubectl get pods

